name: Unit Tests

on:
  push:
    branches: [ teste ]
  pull_request:
    branches: [ teste ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13.3'

    - name: Install dependencies
      working-directory: ./backend
      run: |
        python -m pip install --upgrade pip
        echo "=== Installing main requirements ==="
        pip install -r requirements.txt
        
        echo "=== Checking for requirements-test.txt ==="
        if [ -f requirements-test.txt ]; then
          echo "Found requirements-test.txt, filtering out pywin32..."
          # Cria uma versão filtrada sem pywin32
          grep -v "pywin32" requirements-test.txt > requirements-test-linux.txt || true
          echo "Filtered requirements-test-linux.txt:"
          cat requirements-test-linux.txt
          pip install -r requirements-test-linux.txt
        else
          echo "requirements-test.txt not found"
        fi

    - name: Verify installations
      working-directory: ./backend
      run: |
        echo "=== Checking installed packages ==="
        pip list
        echo "=== Verifying critical packages ==="
        python -c "
        try:
            import fastapi
            print('✅ FastAPI version:', fastapi.__version__)
        except ImportError as e:
            print('❌ FastAPI not found:', e)
            exit(1)
        "
        python -c "
        try:
            import pytest
            print('✅ pytest version:', pytest.__version__)
        except ImportError as e:
            print('❌ pytest not found:', e)
            exit(1)
        "

    - name: Run tests
      working-directory: ./backend
      env:
        ENV: test
        TESTING: true
        DATABASE_URL: "https://testes-plenimind-default-rtdb.firebaseio.com"
        USER_SENSOR_REF: user_sensors_data_test
        USER_PERSONAL_REF: user_registers_test
        ACCESS_TOKEN_EXPIRE_MINUTES: 30
        REFRESH_TOKEN_EXPIRE_DAYS: 7
        JWT_SECRET_KEY: "encrypt-data-jwt-key-2025"
        JWT_ALGORITHM: HS256
      run: |
        python -m pytest tests/unit/ -v --cov=app --cov-report=xml

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./backend/coverage.xml
        flags: unittests