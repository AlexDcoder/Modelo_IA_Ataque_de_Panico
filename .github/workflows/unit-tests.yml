name: Unit Tests

on:
  push:
    branches: [ teste ]
  pull_request:
    branches: [ teste ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13.3'

    - name: Install CI/CD dependencies
      working-directory: ./backend
      run: |
        python -m pip install --upgrade pip
        echo "=== Installing from requirements-ci-cd.txt ==="
        if [ -f requirements-ci-cd.txt ]; then
          pip install -r requirements-ci-cd.txt
          echo "✅ requirements-ci-cd.txt installed successfully"
        else
          echo "❌ requirements-ci-cd.txt not found!"
          echo "Installing from requirements.txt only"
          pip install -r requirements.txt
        fi

    - name: Verify installations
      working-directory: ./backend
      run: |
        echo "=== Checking installed packages ==="
        pip list
        echo "=== Verifying critical packages ==="
        python -c "
        packages = ['fastapi', 'pytest', 'pytest_cov', 'firebase_admin', 'pandas', 'sklearn']
        for pkg in packages:
            try:
                __import__(pkg.replace('-', '_'))
                print(f'✅ {pkg} installed successfully')
            except ImportError as e:
                print(f'❌ {pkg} not found: {e}')
                exit(1)
        print('✅ All critical packages installed successfully')
        "

    - name: Run tests
      working-directory: ./backend
      env:
        ENV: test
        TESTING: true
        DATABASE_URL: "https://testes-plenimind-default-rtdb.firebaseio.com"
        USER_SENSOR_REF: user_sensors_data_test
        USER_PERSONAL_REF: user_registers_test
        ACCESS_TOKEN_EXPIRE_MINUTES: 30
        REFRESH_TOKEN_EXPIRE_DAYS: 7
        JWT_SECRET_KEY: "encrypt-data-jwt-key-2025"
        JWT_ALGORITHM: HS256
      run: |
        python -m pytest tests/unit/ -v --cov=app --cov-report=xml

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./backend/coverage.xml
        flags: unittests