name: Test Backend

on:
  push:
    branches: [ teste ]
  pull_request:
    branches: [ teste ]

jobs:
  test-backend:
    name: Run Backend Tests
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: ["3.13.3"]

    steps:
      - name: üß© Checkout repository
        uses: actions/checkout@v4

      - name: üêç Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: üì¶ Install main dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt

      - name: üì¶ Install test dependencies
        run: |
          cd backend
          pip install pytest pytest-asyncio pytest-cov pytest-xdist
          pip install httpx requests
          pip install bandit safety
          pip install black flake8 mypy isort
          pip install coverage
          pip install Faker factory-boy
          pip install python-dotenv

      - name: ‚öôÔ∏è Setup Test Environment
        run: |
          cd backend/tests/
          cp .env.test .env
          echo "ENV=test" >> $GITHUB_ENV
          echo "TESTING=True" >> $GITHUB_ENV

      - name: üîê Setup Firebase Test Credentials
        run: |
          cd backend
          echo "$FIREBASE_CREDENTIALS_TEST" > firebase-credentials-test.json
          echo "‚úÖ Firebase test credentials configured"
        env:
          FIREBASE_CREDENTIALS_TEST: ${{ secrets.FIREBASE_CREDENTIALS_TEST }}

      - name: üß™ Run pytest with coverage
        run: |
          cd backend
          python -m pytest tests/ \
            --maxfail=5 \
            --disable-warnings \
            -v \
            --junitxml=test-results-${{ matrix.python-version }}.xml \
            --cov=core \
            --cov-report=xml:coverage-${{ matrix.python-version }}.xml \
            --cov-report=html:coverage_html-${{ matrix.python-version }}

      - name: üìä Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-${{ matrix.python-version }}
          path: |
            backend/coverage-${{ matrix.python-version }}.xml
            backend/coverage_html-${{ matrix.python-version }}/

      - name: üì§ Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.python-version }}
          path: backend/test-results-${{ matrix.python-version }}.xml

      - name: üìà Publish Test Results
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Backend Tests (Python ${{ matrix.python-version }})
          path: backend/test-results-${{ matrix.python-version }}.xml
          reporter: java-junit

      - name: üìä Publish Coverage Report
        uses: codecov/codecov-action@v3
        with:
          file: backend/coverage-${{ matrix.python-version }}.xml
          flags: python-${{ matrix.python-version }}
          name: codecov-backend

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: üß© Checkout repository
        uses: actions/checkout@v4

      - name: üì¶ Install security dependencies
        run: |
          pip install bandit safety

      - name: üîí Bandit Security Scan
        run: |
          cd backend
          bandit -r core/ -f html -o security-scan-results.html -ll

      - name: üõ°Ô∏è Safety Dependency Check
        run: |
          cd backend
          safety check --json --output safety-report.json || true

      - name: üìä Upload Security Scan Results
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-results
          path: |
            backend/security-scan-results.html
            backend/safety-report.json

  validate-structure:
    name: Validate Project Structure
    runs-on: ubuntu-latest
    steps:
      - name: üß© Checkout repository
        uses: actions/checkout@v4

      - name: üîç Validate Backend Structure
        run: |
          echo "Validating backend structure..."
          
          essential_files=(
            "backend/requirements.txt"
            "backend/tests/.env.test"
            "backend/main.py"
            "backend/core/config.py"
            "backend/tests/conftest.py"
          )
          
          for file in "${essential_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "‚ùå $file not found!"
              exit 1
            fi
          done
          
          echo "‚úÖ Backend structure is valid!"

      - name: üìã Check Test Files
        run: |
          echo "Checking test files..."
          cd backend/tests
          test_files=$(find . -name "test_*.py" | wc -l)
          echo "üìÅ Found $test_files test files"
          
          if [ $test_files -eq 0 ]; then
            echo "‚ùå No test files found!"
            exit 1
          fi
          
          echo "‚úÖ Test files check passed"

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: test-backend
    steps:
      - name: üß© Checkout repository
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: üì¶ Install dependencies
        run: |
          pip install -r backend/requirements.txt
          pip install pytest pytest-asyncio

      - name: ‚öôÔ∏è Setup Test Environment
        run: |
          cd backend/tests/
          cp .env.test .env
          echo "ENV=test" >> $GITHUB_ENV

      - name: üîê Setup Firebase Test Credentials
        run: |
          cd backend
          echo "$FIREBASE_CREDENTIALS_TEST" > firebase-credentials-test.json
        env:
          FIREBASE_CREDENTIALS_TEST: ${{ secrets.FIREBASE_CREDENTIALS_TEST }}

      - name: üß™ Run Integration Tests
        run: |
          cd backend
          python -m pytest tests/ -m integration -v \
            --junitxml=integration-test-results.xml \
            --tb=short

      - name: üì§ Upload Integration Test Results
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: backend/integration-test-results.xml

  performance-test:
    name: Performance Tests
    runs-on: ubuntu-latest
    steps:
      - name: üß© Checkout repository
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: üì¶ Install dependencies
        run: |
          pip install -r backend/requirements.txt
          pip install pytest

      - name: ‚ö° Run Performance Tests
        run: |
          cd backend
          python -m pytest tests/test_performance.py -v \
            --junitxml=performance-test-results.xml \
            --tb=short

      - name: üìä Upload Performance Test Results
        uses: actions/upload-artifact@v4
        with:
          name: performance-test-results
          path: backend/performance-test-results.xml

  test-summary:
    name: üìä Test Summary Report
    runs-on: ubuntu-latest
    needs: [test-backend, validate-structure, security-scan, integration-test, performance-test]
    if: always()
    steps:
      - name: üìã Generate Test Report
        run: |
          echo "## üß™ Backend Test Results Summary" > $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìà Test Execution Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### ‚úÖ Completed Test Suites" >> $GITHUB_STEP_SUMMARY
          echo "- **Unit Tests**: Python 3.11 & 3.12" >> $GITHUB_STEP_SUMMARY
          echo "- **Integration Tests**: Complete workflow validation" >> $GITHUB_STEP_SUMMARY
          echo "- **Performance Tests**: Response time validation" >> $GITHUB_STEP_SUMMARY
          echo "- **Security Scan**: Bandit & Safety analysis" >> $GITHUB_STEP_SUMMARY
          echo "- **Structure Validation**: Project integrity check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### üîç Test Coverage" >> $GITHUB_STEP_SUMMARY
          echo "- **CT01, CT02**: Authentication tests" >> $GITHUB_STEP_SUMMARY
          echo "- **CT03**: User management tests" >> $GITHUB_STEP_SUMMARY
          echo "- **CT04**: Vital data tests" >> $GITHUB_STEP_SUMMARY
          echo "- **CT05, CT07, CT11**: AI model and feedback tests" >> $GITHUB_STEP_SUMMARY
          echo "- **CT09**: Performance tests" >> $GITHUB_STEP_SUMMARY
          echo "- **CT10**: Security tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### üìÅ Available Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "1. **Test Results**: JUnit XML format" >> $GITHUB_STEP_SUMMARY
          echo "2. **Coverage Reports**: HTML and XML formats" >> $GITHUB_STEP_SUMMARY
          echo "3. **Security Reports**: Bandit HTML & Safety JSON" >> $GITHUB_STEP_SUMMARY
          echo "4. **Performance Results**: Response time metrics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìä Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Download artifacts for detailed analysis" >> $GITHUB_STEP_SUMMARY
          echo "2. Review coverage reports to identify gaps" >> $GITHUB_STEP_SUMMARY
          echo "3. Check security scan results for vulnerabilities" >> $GITHUB_STEP_SUMMARY
          echo "4. Monitor performance metrics over time" >> $GITHUB_STEP_SUMMARY

      - name: üéâ Success Status
        if: success()
        run: |
          echo "## üéä ALL TESTS COMPLETED SUCCESSFULLY!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The backend is **ready for deployment** with comprehensive test coverage and security validation." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ‚úÖ Quality Metrics" >> $GITHUB_STEP_SUMMARY
          echo "- Code coverage reports generated" >> $GITHUB_STEP_SUMMARY
          "- Security vulnerabilities scanned" >> $GITHUB_STEP_SUMMARY
          echo "- Performance benchmarks established" >> $GITHUB_STEP_SUMMARY
          echo "- Integration workflows validated" >> $GITHUB_STEP_SUMMARY

      - name: ‚ö†Ô∏è Partial Success
        if: failure()
        run: |
          echo "## ‚ö†Ô∏è SOME TESTS REQUIRE ATTENTION" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please check the failed test results and fix the issues before deployment." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîß Recommended Actions" >> $GITHUB_STEP_SUMMARY
          echo "1. Review test failure details in artifacts" >> $GITHUB_STEP_SUMMARY
          echo "2. Check security scan results" >> $GITHUB_STEP_SUMMARY
          echo "3. Verify integration test workflows" >> $GITHUB_STEP_SUMMARY
          echo "4. Ensure all critical paths are covered" >> $GITHUB_STEP_SUMMARY

  final-validation:
    name: ‚úÖ Final Validation
    runs-on: ubuntu-latest
    needs: [test-backend, validate-structure, security-scan, integration-test, performance-test, test-summary]
    if: always()
    steps:
      - name: üèÅ Final Status Check
        run: |
          if [ "${{ needs.test-backend.result }}" == "success" ] && \
             [ "${{ needs.validate-structure.result }}" == "success" ] && \
             [ "${{ needs.security-scan.result }}" == "success" ]; then
            echo "üéâ CORE TESTING PASSED - Backend is stable"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è SOME CHECKS FAILED - Review test results"
            echo "status=failure" >> $GITHUB_OUTPUT
          fi

      - name: üì¢ Final Notification
        if: always()
        run: |
          echo "## üèÅ Backend Testing Complete"
          echo ""
          echo "All test workflows have been executed."
          echo "Check individual job results for detailed status."
          echo ""
          echo "**Summary:**"
          echo "- Unit Tests: ${{ needs.test-backend.result }}"
          echo "- Security Scan: ${{ needs.security-scan.result }}"
          echo "- Structure Validation: ${{ needs.validate-structure.result }}"
          echo "- Integration Tests: ${{ needs.integration-test.result }}"
          echo "- Performance Tests: ${{ needs.performance-test.result }}"