name: Test Backend

on:
  push:
    branches: [ teste ]
  pull_request:
    branches: [ teste ]

jobs:
  test-backend:
    name: Run Backend Tests
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: ["3.13.3"]

    steps:
      - name: ðŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: ðŸ“¦ Install main dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt

      - name: ðŸ“¦ Install test dependencies
        run: |
          cd backend
          pip install pytest pytest-asyncio pytest-cov pytest-xdist
          pip install httpx requests
          pip install bandit safety
          pip install black flake8 mypy isort
          pip install coverage
          pip install Faker factory-boy
          pip install python-dotenv

      - name: ðŸ” Setup Firebase Credentials
        run: |
          cd backend
          echo "$FIREBASE_CREDENTIALS" > firebase-credentials.json
          echo "âœ… Firebase credentials configured from GitHub Secrets"
          ls -la firebase-credentials.json
        env:
          FIREBASE_CREDENTIALS: ${{ secrets.FIREBASE_CREDENTIALS }}

      - name: ðŸ§ª Run pytest with coverage
        run: |
          cd backend
          ENV=test TESTING=True python -m pytest tests/ \
            --maxfail=20 \
            --disable-warnings \
            -v \
            --junitxml=test-results-${{ matrix.python-version }}.xml \
            --cov=core \
            --cov-report=xml:coverage-${{ matrix.python-version }}.xml \
            --cov-report=html:coverage_html-${{ matrix.python-version }}

      - name: ðŸ“Š Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-${{ matrix.python-version }}
          path: |
            backend/coverage-${{ matrix.python-version }}.xml
            backend/coverage_html-${{ matrix.python-version }}/

      - name: ðŸ“¤ Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.python-version }}
          path: backend/test-results-${{ matrix.python-version }}.xml

      - name: ðŸ“Š Publish Coverage Report
        uses: codecov/codecov-action@v3
        if: always()
        with:
          file: backend/coverage-${{ matrix.python-version }}.xml
          flags: python-${{ matrix.python-version }}
          name: codecov-backend

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ“¦ Install security dependencies
        run: |
          pip install bandit safety

      - name: ðŸ”’ Bandit Security Scan
        run: |
          cd backend
          bandit -r core/ -f html -o security-scan-results.html -ll

      - name: ðŸ›¡ï¸ Safety Dependency Check
        run: |
          cd backend
          safety check --json --output safety-report.json || true

      - name: ðŸ“Š Upload Security Scan Results
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-results
          path: |
            backend/security-scan-results.html
            backend/safety-report.json

  validate-structure:
    name: Validate Project Structure
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ” Validate Backend Structure
        run: |
          echo "Validating backend structure..."
          
          essential_files=(
            "backend/requirements.txt"
            "backend/main.py"
            "backend/core/config.py"
            "backend/tests/conftest.py"
          )
          
          for file in "${essential_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ $file not found!"
              exit 1
            fi
          done
          
          echo "âœ… Backend structure is valid!"

      - name: ðŸ“‹ Check Test Files
        run: |
          echo "Checking test files..."
          cd backend/tests
          test_files=$(find . -name "test_*.py" | wc -l)
          echo "ðŸ“ Found $test_files test files"
          
          if [ $test_files -eq 0 ]; then
            echo "âŒ No test files found!"
            exit 1
          fi
          
          echo "âœ… Test files check passed"

  performance-test:
    name: Performance Tests
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13.3"

      - name: ðŸ“¦ Install dependencies
        run: |
          pip install -r backend/requirements.txt
          pip install pytest

      - name: ðŸ” Setup Firebase Credentials
        run: |
          cd backend
          echo "$FIREBASE_CREDENTIALS" > firebase-credentials.json
        env:
          FIREBASE_CREDENTIALS: ${{ secrets.FIREBASE_CREDENTIALS }}

      - name: âš¡ Run Performance Tests
        run: |
          cd backend
          ENV=test TESTING=True python -m pytest tests/test_performance.py -v \
            --junitxml=performance-test-results.xml \
            --tb=short

      - name: ðŸ“Š Upload Performance Test Results
        uses: actions/upload-artifact@v4
        with:
          name: performance-test-results
          path: backend/performance-test-results.xml

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13.3"

      - name: ðŸ“¦ Install dependencies
        run: |
          pip install -r backend/requirements.txt
          pip install pytest pytest-asyncio

      - name: ðŸ” Setup Firebase Credentials
        run: |
          cd backend
          echo "$FIREBASE_CREDENTIALS" > firebase-credentials.json
        env:
          FIREBASE_CREDENTIALS: ${{ secrets.FIREBASE_CREDENTIALS }}

      - name: ðŸ”— Run Integration Tests
        run: |
          cd backend
          ENV=test TESTING=True python -m pytest tests/ -m integration -v \
            --junitxml=integration-test-results.xml \
            --tb=short

      - name: ðŸ“¤ Upload Integration Test Results
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: backend/integration-test-results.xml

  test-summary:
    name: ðŸ“Š Test Summary Report
    runs-on: ubuntu-latest
    needs: [test-backend, validate-structure, security-scan, performance-test, integration-test]
    if: always()
    steps:
      - name: ðŸ“‹ Download Test Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: test-results-*
          merge-multiple: true

      - name: ðŸ“ˆ Generate Test Report
        run: |
          echo "## ðŸ§ª Backend Test Results Summary" > $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Test Execution Overview" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Status dos jobs
          echo "#### âœ… Job Status" >> $GITHUB_STEP_SUMMARY
          echo "- **Unit Tests**: ${{ needs.test-backend.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Security Scan**: ${{ needs.security-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Structure Validation**: ${{ needs.validate-structure.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Performance Tests**: ${{ needs.performance-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Integration Tests**: ${{ needs.integration-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "#### ðŸ” Test Coverage Areas" >> $GITHUB_STEP_SUMMARY
          echo "- **CT01, CT02**: Authentication & Login" >> $GITHUB_STEP_SUMMARY
          echo "- **CT03**: User Management & Registration" >> $GITHUB_STEP_SUMMARY
          echo "- **CT04**: Vital Data Collection" >> $GITHUB_STEP_SUMMARY
          echo "- **CT05, CT07, CT11**: AI Model & Feedback System" >> $GITHUB_STEP_SUMMARY
          echo "- **CT09**: Performance & Response Time" >> $GITHUB_STEP_SUMMARY
          echo "- **CT10**: Security & Data Protection" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "#### ðŸ“ Available Reports" >> $GITHUB_STEP_SUMMARY
          echo "1. **Test Results**: JUnit XML format (download from Artifacts)" >> $GITHUB_STEP_SUMMARY
          echo "2. **Coverage Reports**: Interactive HTML reports" >> $GITHUB_STEP_SUMMARY
          echo "3. **Security Analysis**: Bandit & Safety reports" >> $GITHUB_STEP_SUMMARY
          echo "4. **Performance Metrics**: Response time analysis" >> $GITHUB_STEP_SUMMARY
          echo "5. **Integration Results**: End-to-end workflow validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: ðŸŽ‰ Success Status
        if: success()
        run: |
          echo "## ðŸŽŠ ALL TESTS PASSED SUCCESSFULLY!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Quality Gates Met" >> $GITHUB_STEP_SUMMARY
          echo "- All test suites executed without critical failures" >> $GITHUB_STEP_SUMMARY
          echo "- Code coverage reports generated successfully" >> $GITHUB_STEP_SUMMARY
          echo "- Security scan completed with no critical vulnerabilities" >> $GITHUB_STEP_SUMMARY
          echo "- Project structure validated" >> $GITHUB_STEP_SUMMARY
          echo "- Performance benchmarks established" >> $GITHUB_STEP_SUMMARY
          echo "- Integration workflows verified" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The backend is **ready for the next development phase** with comprehensive test validation." >> $GITHUB_STEP_SUMMARY

      - name: âš ï¸ Tests Failed
        if: failure()
        run: |
          echo "## âŒ SOME TESTS FAILED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ Required Actions" >> $GITHUB_STEP_SUMMARY
          echo "1. **Review Test Failures**: Check the test-results artifacts for detailed error information" >> $GITHUB_STEP_SUMMARY
          echo "2. **Fix Critical Issues**: Address any authentication, data validation, or security issues" >> $GITHUB_STEP_SUMMARY
          echo "3. **Verify Dependencies**: Ensure all required packages are properly installed" >> $GITHUB_STEP_SUMMARY
          echo "4. **Check Firebase Configuration**: Verify credentials and database connections" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Failed Jobs:" >> $GITHUB_STEP_SUMMARY
          echo "- Unit Tests: ${{ needs.test-backend.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Security Scan: ${{ needs.security-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Structure Validation: ${{ needs.validate-structure.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Performance Tests: ${{ needs.performance-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Integration Tests: ${{ needs.integration-test.result }}" >> $GITHUB_STEP_SUMMARY

  final-validation:
    name: âœ… Final Validation
    runs-on: ubuntu-latest
    needs: [test-backend, validate-structure, security-scan, performance-test, integration-test, test-summary]
    if: always()
    steps:
      - name: ðŸ Final Status Check
        run: |
          echo "## ðŸ Backend Testing Complete"
          echo ""
          echo "### ðŸ“‹ Final Results Summary"
          echo ""
          echo "| Test Category | Status |"
          echo "|---------------|--------|"
          echo "| Unit Tests | ${{ needs.test-backend.result }} |"
          echo "| Security Scan | ${{ needs.security-scan.result }} |"
          echo "| Structure Validation | ${{ needs.validate-structure.result }} |"
          echo "| Performance Tests | ${{ needs.performance-test.result }} |"
          echo "| Integration Tests | ${{ needs.integration-test.result }} |"
          echo ""
          
          if [ "${{ needs.test-backend.result }}" == "success" ] && \
             [ "${{ needs.validate-structure.result }}" == "success" ] && \
             [ "${{ needs.security-scan.result }}" == "success" ]; then
            echo "ðŸŽ‰ **CORE TESTING PASSED** - Backend structure and security are validated"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ **CORE TESTING ISSUES** - Review failed tests before proceeding"
            echo "status=failure" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ“¢ Final Notification
        if: always()
        run: |
          echo "### ðŸ“¬ Next Steps"
          echo ""
          echo "1. **Download Artifacts**: Get detailed reports from the Artifacts section"
          echo "2. **Review Coverage**: Check code coverage in the HTML reports"
          echo "3. **Security Review**: Examine Bandit and Safety reports"
          echo "4. **Performance Analysis**: Review response time metrics"
          echo "5. **Integration Validation**: Verify end-to-end workflows"
          echo ""
          echo "---"
          echo "*Testing completed at: $(date)*"