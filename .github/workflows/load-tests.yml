name: Load Tests

on:
  schedule:
    - cron: '0 0 * * *'  # Executa diariamente à meia-noite
  workflow_dispatch:      # Permite execução manual

jobs:
  loadtest:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13.3'

    - name: Install dependencies
      working-directory: ./backend
      run: |
        python -m pip install --upgrade pip
        echo "=== Installing main requirements ==="
        pip install -r requirements.txt
        
        echo "=== Checking for requirements-test.txt ==="
        if [ -f requirements-test.txt ]; then
          echo "Found requirements-test.txt, filtering out pywin32..."
          # Cria uma versão filtrada sem pywin32
          grep -v "pywin32" requirements-test.txt > requirements-test-linux.txt || true
          echo "Filtered requirements-test-linux.txt:"
          cat requirements-test-linux.txt
          pip install -r requirements-test-linux.txt
        else
          echo "requirements-test.txt not found"
        fi
        
        echo "=== Installing Locust ==="
        pip install locust==2.20.1 requests==2.31.0

    - name: Verify installations
      working-directory: ./backend
      run: |
        echo "=== Checking installed packages ==="
        pip list
        echo "=== Verifying critical packages ==="
        python -c "
        try:
            import fastapi
            print('✅ FastAPI version:', fastapi.__version__)
        except ImportError as e:
            print('❌ FastAPI not found:', e)
            exit(1)
        "
        python -c "
        try:
            import locust
            print('✅ Locust version:', locust.__version__)
        except ImportError as e:
            print('❌ Locust not found:', e)
            exit(1)
        "

    - name: Run Locust tests
      working-directory: ./backend
      env:
        ENV: test
        TESTING: true
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        CREDENTIAL_FIREBASE: ${{ secrets.CREDENTIAL_FIREBASE }}
        USER_SENSOR_REF: user_sensors_data_test
        USER_PERSONAL_REF: user_registers_test
        ACCESS_TOKEN_EXPIRE_MINUTES: 30
        REFRESH_TOKEN_EXPIRE_DAYS: 7
        JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
        JWT_ALGORITHM: HS256
        TEST_HOST: ${{ github.event.inputs.test_host || secrets.TEST_HOST }}
      run: |
        echo "Testing host: $TEST_HOST"
        locust -f tests/performance/locustfile.py \
          --headless \
          --users 50 \
          --spawn-rate 5 \
          --run-time 5m \
          --host $TEST_HOST \
          --html locust-report.html

    - name: Upload Locust report
      uses: actions/upload-artifact@v3
      with:
        name: locust-report
        path: ./backend/locust-report.html
        retention-days: 30