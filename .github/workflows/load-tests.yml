name: Load Tests

on:
  schedule:
    - cron: '0 0 * * *'  # Executa diariamente à meia-noite
  workflow_dispatch:      # Permite execução manual

jobs:
  loadtest:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13.3'

    - name: Install CI/CD dependencies
      working-directory: ./backend
      run: |
        python -m pip install --upgrade pip
        echo "=== Installing from requirements-ci-cd.txt ==="
        if [ -f requirements-ci-cd.txt ]; then
          pip install -r requirements-ci-cd.txt
          echo "✅ requirements-ci-cd.txt installed successfully"
        else
          echo "❌ requirements-ci-cd.txt not found!"
          echo "Installing from requirements.txt and locust separately"
          pip install -r requirements.txt
          pip install locust==2.20.1 requests==2.31.0
        fi

    - name: Verify installations
      working-directory: ./backend
      run: |
        echo "=== Checking installed packages ==="
        pip list
        echo "=== Verifying critical packages ==="
        python -c "
        packages = ['fastapi', 'locust', 'firebase_admin', 'pandas']
        for pkg in packages:
            try:
                __import__(pkg.replace('-', '_'))
                print(f'✅ {pkg} installed successfully')
            except ImportError as e:
                print(f'❌ {pkg} not found: {e}')
                exit(1)
        print('✅ All critical packages installed successfully')
        "

    - name: Run Locust tests
      working-directory: ./backend
      env:
        ENV: test
        TESTING: true
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        CREDENTIAL_FIREBASE: ${{ secrets.CREDENTIAL_FIREBASE }}
        USER_SENSOR_REF: user_sensors_data_test
        USER_PERSONAL_REF: user_registers_test
        ACCESS_TOKEN_EXPIRE_MINUTES: 30
        REFRESH_TOKEN_EXPIRE_DAYS: 7
        JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
        JWT_ALGORITHM: HS256
        TEST_HOST: ${{ github.event.inputs.test_host || secrets.TEST_HOST }}
      run: |
        echo "Testing host: $TEST_HOST"
        locust -f tests/performance/locustfile.py \
          --headless \
          --users 50 \
          --spawn-rate 5 \
          --run-time 5m \
          --host $TEST_HOST \
          --html locust-report.html

    - name: Upload Locust report
      uses: actions/upload-artifact@v3
      with:
        name: locust-report
        path: ./backend/locust-report.html
        retention-days: 30