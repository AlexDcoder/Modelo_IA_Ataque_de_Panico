name: Load Tests

on:
  schedule:
    - cron: '0 0 * * *'  # Executa diariamente à meia-noite
  workflow_dispatch:      # Permite execução manual

jobs:
  loadtest:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13.3'

    - name: Install dependencies
      working-directory: ./backend
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
        # Instala requirements-test.txt ignorando pywin32
        if [ -f requirements-test.txt ]; then
          grep -v "pywin32" requirements-test.txt > requirements-test-linux.txt || true
          pip install -r requirements-test-linux.txt
        fi
        
        # Instala dependências do Locust separadamente
        pip install locust==2.20.1 requests==2.31.0

    - name: Run Locust tests
      working-directory: ./backend
      env:
        ENV: test
        TESTING: true
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        CREDENTIAL_FIREBASE: ${{ secrets.CREDENTIAL_FIREBASE }}
        USER_SENSOR_REF: user_sensors_data_test
        USER_PERSONAL_REF: user_registers_test
        ACCESS_TOKEN_EXPIRE_MINUTES: 30
        REFRESH_TOKEN_EXPIRE_DAYS: 7
        JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
        JWT_ALGORITHM: HS256
        TEST_HOST: ${{ github.event.inputs.test_host || secrets.TEST_HOST }}
      run: |
        locust -f tests/performance/locustfile.py \
          --headless \
          --users 50 \
          --spawn-rate 5 \
          --run-time 5m \
          --host $TEST_HOST \
          --html locust-report.html

    - name: Upload Locust report
      uses: actions/upload-artifact@v3
      with:
        name: locust-report
        path: ./backend/locust-report.html
        retention-days: 30